{"version":3,"file":"updateCurrentBuffer.js","sources":["../../../../Source/WorkersES6/updateCurrentBuffer.js"],"sourcesContent":["import createTaskProcessorWorker from \"./createTaskProcessorWorker.js\";\r\n\r\nfunction clampBetween(v, min, max) {\r\n  if (v <= min)\r\n    v = min;\r\n\r\n  if (v >= max)\r\n    v = max;\r\n\r\n  return v;\r\n}\r\n\r\nfunction equivalent(a, b) {\r\n  if (Math.abs(a - b) < 0.00001)\r\n    return true;\r\n  else\r\n    return false;\r\n}\r\n\r\nfunction toRadians(d) {\r\n  return d * (Math.PI / 180.0);\r\n}\r\n\r\nfunction magnitude(cartesian) {\r\n  return Math.sqrt(cartesian.x * cartesian.x + cartesian.y * cartesian.y + cartesian.z * cartesian.z);\r\n}\r\n\r\nfunction normalize(cartesian, result) {\r\n  var mag = magnitude(cartesian);\r\n\r\n  result.x = cartesian.x / mag;\r\n  result.y = cartesian.y / mag;\r\n  result.z = cartesian.z / mag;\r\n}\r\n\r\nfunction multiplyComponents(left, right, result) {\r\n  result.x = left.x * right.x;\r\n  result.y = left.y * right.y;\r\n  result.z = left.z * right.z;\r\n}\r\n\r\nfunction dot(left, right) {\r\n  return left.x * right.x + left.y * right.y + left.z * right.z;\r\n}\r\n\r\nfunction divideByScalar(cartesian, scalar, result) {\r\n  result.x = cartesian.x / scalar;\r\n  result.y = cartesian.y / scalar;\r\n  result.z = cartesian.z / scalar;\r\n  return result;\r\n};\r\n\r\nfunction multiplyByScalar(cartesian, scalar, result) {\r\n  result.x = cartesian.x * scalar;\r\n  result.y = cartesian.y * scalar;\r\n  result.z = cartesian.z * scalar;\r\n  return result;\r\n};\r\n\r\nfunction add(left, right, result) {\r\n  result.x = left.x + right.x;\r\n  result.y = left.y + right.y;\r\n  result.z = left.z + right.z;\r\n  return result;\r\n};\r\n\r\nfunction magnitudeSquared(cartesian) {\r\n  return cartesian.x * cartesian.x + cartesian.y * cartesian.y + cartesian.z * cartesian.z;\r\n};\r\n\r\nfunction checkPointVisible(primitive, pos) {\r\n  if (magnitudeSquared(pos) < 1)\r\n    return false;\r\n\r\n  var posDir = new Object();\r\n  posDir.x = pos.x;\r\n  posDir.y = pos.y;\r\n  posDir.z = pos.z;\r\n  normalize(posDir, posDir);\r\n\r\n  var camDir = new Object();\r\n  camDir.x = primitive._camPosition.x;\r\n  camDir.y = primitive._camPosition.y;\r\n  camDir.z = primitive._camPosition.z;\r\n  normalize(camDir, camDir);\r\n\r\n  var d = dot(posDir, camDir);\r\n  d = clampBetween(d, -1, 1);\r\n\r\n  var angle = Math.acos(d);\r\n\r\n  if (angle > primitive._visibleAngle)\r\n    return false;\r\n  else\r\n    return true;\r\n}\r\n\r\nfunction cartographicToCartesian(cartographic) {\r\n  var result = new Object();\r\n\r\n  var n = new Object();\r\n  var k = new Object();\r\n\r\n  var longitude = cartographic.longitude;\r\n  var latitude = cartographic.latitude;\r\n  var cosLatitude = Math.cos(latitude);\r\n\r\n  var x = cosLatitude * Math.cos(longitude);\r\n  var y = cosLatitude * Math.sin(longitude);\r\n  var z = Math.sin(latitude);\r\n\r\n  n.x = x;\r\n  n.y = y;\r\n  n.z = z;\r\n  normalize(n, n);\r\n\r\n  var radiiSquared = new Object();\r\n  radiiSquared.x = 6378137.0 * 6378137.0;\r\n  radiiSquared.y = 6378137.0 * 6378137.0;\r\n  radiiSquared.z = 6356752.314145179 * 6356752.314145179;\r\n\r\n  multiplyComponents(radiiSquared, n, k);\r\n  var gamma = Math.sqrt(dot(n, k));\r\n  divideByScalar(k, gamma, k);\r\n  multiplyByScalar(n, cartographic.height, n);\r\n\r\n  add(k, n, result);\r\n\r\n  return result;\r\n}\r\n\r\nfunction random(min, max) {\r\n  var Range = max - min;\r\n  var Rand = Math.random();\r\n  var num = min + Math.round(Rand * Range);\r\n  return num;\r\n}\r\n\r\nfunction randomParticle(primitive, currentParticle) {\r\n  currentParticle.age = Math.round(random(0.0, primitive._numCurrentPoint - 1));\r\n  currentParticle.pos = new Object();\r\n  currentParticle.pos.x = random(0.0, primitive._currentData.depthLength - 1);\r\n  currentParticle.pos.y = random(primitive._currentMinLat, primitive._currentMaxLat);\r\n  currentParticle.pos.z = random(primitive._currentMinLon, primitive._currentMaxLon);\r\n  currentParticle.dir = new Object();\r\n  currentParticle.lastTime = -1;\r\n  currentParticle.firstTime = true;\r\n}\r\n\r\n//by start HGT:解决二维线跨180度问题   刘雨   20180904\r\nfunction isInViewRange(minLon, maxLon, minLat, maxLat, stepOver360Lon, position) {\r\n  var longitude = position[0];\r\n  var latitude = position[1];\r\n  if (longitude < 0) {\r\n    longitude += 360;\r\n  } else if (longitude > 0 && stepOver360Lon) {\r\n    longitude += 360;\r\n  }\r\n  var isFlagLong = (longitude >= minLon && longitude <= maxLon) ? true : false;\r\n  var isFlagLat = (latitude >= minLat && latitude <= maxLat) ? true : false;\r\n  return (isFlagLong && isFlagLat);\r\n}\r\n//end\r\n\r\nfunction updateCurrentBuffer(parameters, transferableObjects) {\r\n  var primitive = parameters;\r\n  //by start HGT:解决二维线跨180度问题   刘雨   20180904\r\n  var viewMinLat = primitive._viewMinLat;\r\n  var viewMaxLat = primitive._viewMaxLat;\r\n  var viewMinLon = primitive._viewMinLon;\r\n  var viewMaxLon = primitive._viewMaxLon;\r\n  var stepOver360Lon = primitive._stepOver360Lon;\r\n  //end\r\n  for (var i = 0; i < primitive._currentParticleArr.length; ++i) {\r\n    if (primitive._currentParticleArr[i].age < primitive._numCurrentPoint) {\r\n      var visible = false;\r\n      if (primitive._is3d) {\r\n        visible = checkPointVisible(primitive, primitive._currentParticleArr[i].wPos);\r\n      } else {\r\n        //by start HGT:解决二维线跨180度问题   刘雨   20180904\r\n        if (isInViewRange(viewMinLon, viewMaxLon, viewMinLat, viewMaxLat, stepOver360Lon, primitive._currentParticleCartographicArr[i])) {\r\n          visible = true;\r\n        }\r\n        //end\r\n      }\r\n      var alphaIndex = i * primitive._numCurrentPoint;\r\n      for (var j = 0; j < primitive._numCurrentPoint; ++j) {\r\n        if (!visible) {\r\n          primitive._alphaArr[alphaIndex + j] = 0;\r\n        }\r\n        else {\r\n          if (j < primitive._currentParticleArr[i].age) {\r\n            var curAlpha = primitive._alphaArr[alphaIndex + j];\r\n            curAlpha -= primitive._currentFadeSpeed;\r\n            curAlpha = clampBetween(curAlpha, 0, 255);\r\n\r\n            primitive._alphaArr[alphaIndex + j] = curAlpha;\r\n          }\r\n          else if (j == primitive._currentParticleArr[i].age) {\r\n            primitive._alphaArr[alphaIndex + j] = 255;\r\n          }\r\n          else {\r\n            primitive._alphaArr[alphaIndex + j] = 0;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    else {\r\n      var alphaIndex = i * primitive._numCurrentPoint;\r\n\r\n      if (!equivalent(0, primitive._alphaArr[alphaIndex + primitive._numCurrentPoint - 1])) {\r\n        var visible = false;\r\n        if (primitive._is3d) {\r\n          visible = checkPointVisible(primitive, primitive._currentParticleArr[i].wPos);\r\n        } else {\r\n          //by start HGT:解决二维线跨180度问题   刘雨   20180904\r\n          if (isInViewRange(viewMaxLat, viewMaxLon, viewMinLat, viewMaxLat, stepOver360Lon, primitive._currentParticleCartographicArr[i])) {\r\n            visible = true;\r\n          }\r\n          //end\r\n        }\r\n\r\n        for (var j = 0; j < primitive._numCurrentPoint; ++j) {\r\n          if (j < primitive._currentParticleArr[i].age) {\r\n            if (!visible) {\r\n              primitive._alphaArr[alphaIndex + j] = 0;\r\n            }\r\n            else {\r\n              var curAlpha = primitive._alphaArr[alphaIndex + j];\r\n              curAlpha -= primitive._currentFadeSpeed;\r\n              curAlpha = clampBetween(curAlpha, 0, 255);\r\n\r\n              primitive._alphaArr[alphaIndex + j] = curAlpha;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return primitive._alphaArr;\r\n}\r\nexport default createTaskProcessorWorker(updateCurrentBuffer);\r\n"],"names":[],"mappings":"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"}